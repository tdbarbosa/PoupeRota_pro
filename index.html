<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoupeRota PRO - LogÃ­stica Inteligente</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #00d1b2; --dark-bg: #101820; --card-bg: #1a232e; 
            --text-main: #ffffff; --text-dim: #a0aec0; --danger: #ff4757;
            --accent: #3498db;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background: var(--dark-bg); color: var(--text-main); overflow: hidden; }
        
        /* Sidebar Estilizada */
        #sidebar { 
            width: 400px; background: var(--card-bg); display: flex; flex-direction: column; 
            box-shadow: 10px 0 30px rgba(0,0,0,0.5); z-index: 1000; border-right: 1px solid #2d3748;
        }
        .header { padding: 25px; text-align: center; border-bottom: 1px solid #2d3748; }
        .logo { font-size: 1.8rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
        .stats { font-size: 0.8rem; color: var(--text-dim); margin-top: 5px; }

        #lista-entregas { flex-grow: 1; overflow-y: auto; padding: 15px; }
        
        /* Cards de Entrega */
        .entrega-card { 
            background: #242f3f; border-radius: 12px; padding: 16px; margin-bottom: 12px; 
            position: relative; border: 1px solid #2d3748; transition: all 0.2s ease;
        }
        .entrega-card:hover { transform: translateY(-2px); border-color: var(--primary); }
        .entrega-card.done { opacity: 0.4; filter: grayscale(0.8); border-color: transparent; }
        
        .badge-bairro { 
            background: rgba(0, 209, 178, 0.1); color: var(--primary); 
            padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
        }
        .endereco { display: block; margin: 10px 0; font-size: 0.9rem; color: var(--text-main); line-height: 1.4; }
        .ordem-numero { 
            position: absolute; top: 16px; right: 16px; background: var(--primary); 
            color: var(--dark-bg); width: 24px; height: 24px; border-radius: 6px; 
            display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.8rem;
        }

        /* BotÃµes */
        .btn-primary { 
            background: var(--primary); color: var(--dark-bg); border: none; padding: 14px; 
            border-radius: 10px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.3s;
        }
        .btn-gps { 
            background: var(--accent); color: white; border: none; padding: 10px; 
            border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; text-decoration: none;
            display: inline-block; text-align: center; margin-bottom: 8px;
        }
        .btn-done { 
            background: transparent; border: 1px solid #4a5568; color: var(--text-dim); 
            padding: 8px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600;
        }
        .btn-done:hover { border-color: var(--primary); color: var(--primary); }
        
        .footer-actions { padding: 20px; border-top: 1px solid #2d3748; background: #1a232e; }
        .btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); padding: 10px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; }

        /* Mapa */
        #map { flex-grow: 1; background: #0b0e14; }
        
        /* Modal */
        #modal-finish {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--card-bg); padding: 40px; border-radius: 20px; z-index: 3000;
            text-align: center; border: 1px solid var(--primary); box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="header">
        <div class="logo">POUPEROTA<span style="color:white">PRO</span></div>
        <div id="stats-text" class="stats">Aguardando romaneio...</div>
    </div>

    <div id="upload-section" style="padding: 20px;">
        <div class="upload-box" onclick="document.getElementById('file-input').click()" style="border: 2px dashed #4a5568; padding: 30px; border-radius: 15px; text-align: center; cursor: pointer;">
            <span style="font-size: 2rem;">ðŸ“¦</span><br>
            <span style="font-size: 0.8rem; color: var(--text-dim)">Arraste ou clique para carregar<br>Excel ou CSV</span>
            <input type="file" id="file-input" style="display:none" accept=".csv, .xlsx, .xls">
        </div>
    </div>
    
    <div style="padding: 0 20px;">
        <button id="btn-reotimizar" class="btn-primary" style="display:none; margin-bottom: 10px;" onclick="reotimizar()">ðŸ”„ RECALCULAR ROTA ATUAL</button>
    </div>

    <div id="lista-entregas"></div>

    <div class="footer-actions" id="footer-ui" style="display: none;">
        <button class="btn-danger" onclick="window.location.reload()">ðŸ§¹ LIMPAR E SAIR</button>
    </div>
</div>

<div id="map"></div>

<div id="modal-finish">
    <h1 style="color: var(--primary); margin: 0;">FIM DA ROTA!</h1>
    <p style="color: var(--text-dim);">Excelente trabalho. Todos os pacotes foram entregues.</p>
    <button class="btn-primary" onclick="window.location.reload()">NOVA CARGA</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false }).setView([-16.6808, -49.2563], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    let layerGrupo = L.layerGroup().addTo(map);
    let dadosOriginais = []; 
    let minhaPosicao = null;

    navigator.geolocation.getCurrentPosition(pos => {
        minhaPosicao = { lat: pos.coords.latitude, lon: pos.coords.longitude };
    });

    document.getElementById('file-input').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        const ext = file.name.split('.').pop().toLowerCase();

        reader.onload = function(evt) {
            let data;
            if (ext === 'csv') {
                Papa.parse(evt.target.result, { header: true, skipEmptyLines: true, complete: (res) => carregarDados(res.data, res.meta.fields) });
            } else {
                const wb = XLSX.read(evt.target.result, { type: 'binary' });
                data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                carregarDados(data, Object.keys(data[0] || {}));
            }
        };
        ext === 'csv' ? reader.readAsText(file) : reader.readAsBinaryString(file);
    };

    function carregarDados(dados, colunas) {
        const limpar = (s) => s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().replace(/[^a-z0-9]/g, "");
        const acharCol = (termos) => colunas.find(c => termos.includes(limpar(c)));

        const cLat = acharCol(['latitude', 'lat']), cLon = acharCol(['longitude', 'long']);
        const cAddr = acharCol(['address', 'endereco', 'rua', 'destinationaddress']);
        const cBairro = acharCol(['bairro', 'neighborhood', 'setor']);

        dadosOriginais = dados.map((row, index) => ({
            id: index,
            lat: parseFloat(String(row[cLat] || '').replace(',', '.')),
            lon: parseFloat(String(row[cLon] || '').replace(',', '.')),
            addr: row[cAddr] || "EndereÃ§o nÃ£o identificado",
            bairro: row[cBairro] || "GoiÃ¢nia",
            concluido: false
        })).filter(p => !isNaN(p.lat) && !isNaN(p.lon));

        if (dadosOriginais.length > 0) {
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('btn-reotimizar').style.display = 'block';
            document.getElementById('footer-ui').style.display = 'block';
            reotimizar();
        }
    }

    function reotimizar() {
        let pendentes = dadosOriginais.filter(p => !p.concluido);
        let finalizados = dadosOriginais.filter(p => p.concluido);
        let rotaNova = [];
        let atual = minhaPosicao || (pendentes.length > 0 ? {lat: pendentes[0].lat, lon: pendentes[0].lon} : null);

        while (pendentes.length > 0) {
            pendentes.sort((a, b) => Math.hypot(a.lat - atual.lat, a.lon - atual.lon) - Math.hypot(b.lat - atual.lat, b.lon - atual.lon));
            atual = pendentes.splice(0, 1)[0];
            rotaNova.push(atual);
        }
        desenhar(rotaNova, finalizados);
        atualizarStats(rotaNova.length, finalizados.length);
    }

    function desenhar(pendentes, finalizados) {
        layerGrupo.clearLayers();
        const listaDiv = document.getElementById('lista-entregas');
        listaDiv.innerHTML = '';
        const exibir = [...pendentes, ...finalizados];

        exibir.forEach((p, i) => {
            const marker = L.circleMarker([p.lat, p.lon], {
                radius: 8, fillOpacity: 0.8, color: p.concluido ? '#4a5568' : '#00d1b2', fillColor: p.concluido ? '#2d3748' : '#00d1b2'
            }).addTo(layerGrupo);
            
            const card = document.createElement('div');
            card.className = `entrega-card ${p.concluido ? 'done' : ''}`;
            card.innerHTML = `
                ${!p.concluido ? `<div class="ordem-numero">${i+1}</div>` : ''}
                <span class="badge-bairro">${p.bairro}</span>
                <span class="endereco">${p.addr}</span>
                <div style="display: flex; gap: 8px;">
                    ${!p.concluido ? `<a class="btn-gps" href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">NAVEGAR</a>` : ''}
                    <button class="btn-done" onclick="alternarStatus(${p.id})">${p.concluido ? 'REABRIR' : 'CONCLUIR'}</button>
                </div>
            `;
            listaDiv.appendChild(card);
        });

        if (pendentes.length === 0 && finalizados.length > 0) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            document.getElementById('modal-finish').style.display = 'block';
        }
        if (exibir.length > 0) map.fitBounds(L.featureGroup(layerGrupo.getLayers()).getBounds(), {padding: [50,50]});
    }

    function atualizarStats(p, f) {
        document.getElementById('stats-text').innerText = `${p} pendentes | ${f} concluÃ­das`;
    }

    function alternarStatus(id) {
        const p = dadosOriginais.find(d => d.id === id);
        if (p) { p.concluido = !p.concluido; reotimizar(); }
    }
</script>
</body>
</html>
