<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoupeRota Pro - V3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #00d1b2; --accent: #ff7f50; --dark-bg: #101820; 
            --card-bg: #1a232e; --text-main: #ffffff; --text-dim: #a0aec0; --danger: #ff4757;
            --map-filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        /* VariÃ¡veis do Modo Claro */
        body.light-mode {
            --dark-bg: #f4f7f6; --card-bg: #ffffff; --text-main: #1a252f;
            --text-dim: #7f8c8d; --map-filter: none;
        }
        
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background: var(--dark-bg); color: var(--text-main); overflow: hidden; transition: 0.3s; }
        
        #sidebar { 
            width: 380px; background: var(--card-bg); display: flex; flex-direction: column; 
            box-shadow: 10px 0 30px rgba(0,0,0,0.5); z-index: 1000; border-right: 1px solid #2d3748;
        }

        .header { 
            padding: 15px 20px; display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid #2d3748; background: rgba(0,0,0,0.1); position: relative;
        }
        .logo-img { width: 42px; height: 42px; object-fit: contain; }
        .logo-text { font-size: 1.2rem; font-weight: 800; margin: 0; }
        
        /* BotÃ£o Alternar Tema */
        #theme-toggle {
            position: absolute; right: 15px; top: 22px; background: transparent; 
            border: 1px solid var(--text-dim); color: var(--text-main); 
            padding: 5px 8px; border-radius: 8px; cursor: pointer; font-size: 0.8rem;
        }

        #lista-entregas { flex-grow: 1; overflow-y: auto; padding: 15px; scroll-behavior: smooth; }
        
        .entrega-card { 
            background: rgba(128,128,128,0.1); border-radius: 12px; padding: 16px; margin-bottom: 12px; 
            border: 2px solid transparent; transition: 0.3s; cursor: pointer;
        }
        .light-mode .entrega-card { background: #f9f9f9; border: 1px solid #ddd; }
        .entrega-card.selected { border-color: var(--primary); background: rgba(0,209,178,0.15); }
        .entrega-card.done { opacity: 0.3; filter: grayscale(1); }
        
        .badge-bairro { 
            background: var(--primary); color: #fff; 
            padding: 3px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
        }
        .endereco { display: block; margin: 8px 0; font-size: 0.85rem; font-weight: 600; }
        
        .btn-gps { 
            background: #3498db; color: white; border: none; padding: 10px; 
            border-radius: 8px; cursor: pointer; width: 100%; font-weight: 700; text-decoration: none;
            display: inline-block; text-align: center; margin-bottom: 6px; font-size: 0.9rem;
        }
        .btn-done { 
            background: transparent; border: 1px solid var(--primary); color: var(--primary); 
            padding: 8px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 700;
        }

        .footer-actions { padding: 15px; background: rgba(0,0,0,0.05); }
        .btn-reotimizar { background: var(--primary); color: #fff; border: none; padding: 14px; border-radius: 10px; font-weight: 800; width: 100%; cursor: pointer; box-shadow: 0 4px 15px rgba(0,209,178,0.3); }

        #map { flex-grow: 1; transition: filter 0.3s; }
        .leaflet-layer { filter: var(--map-filter); }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.6); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .marker-focus { animation: pulse 0.8s infinite; z-index: 9999 !important; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="header">
        <img src="logo.png" alt="Logo" class="logo-img">
        <div>
            <h1 class="logo-text">PoupeRota <span style="color:var(--accent)">Pro</span></h1>
            <div id="stats-text" style="font-size: 0.7rem; color: var(--text-dim);">Aguardando...</div>
        </div>
        <button id="theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>
    </div>

    <div id="upload-section" style="padding: 20px; text-align:center;">
        <label class="btn-reotimizar" style="display:block; cursor:pointer;">
            ðŸ“‚ CARREGAR PLANILHA
            <input type="file" id="file-input" style="display:none" accept=".csv, .xlsx, .xls">
        </label>
    </div>
    
    <div id="lista-entregas"></div>

    <div class="footer-actions" id="footer-ui" style="display: none;">
        <button class="btn-reotimizar" onclick="forcarRecalculo()">ðŸ”„ RECALCULAR AGORA</button>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false }).setView([-16.6808, -49.2563], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let layerGrupo = L.layerGroup().addTo(map);
    let dadosOriginais = []; 
    let marcadoresRef = {};
    let userPos = null;

    // Monitorar GPS constantemente
    navigator.geolocation.watchPosition(pos => {
        userPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
    }, null, { enableHighAccuracy: true });

    function toggleTheme() {
        document.body.classList.toggle('light-mode');
    }

    document.getElementById('file-input').onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        const ext = file.name.split('.').pop().toLowerCase();
        reader.onload = (evt) => {
            if (ext === 'csv') {
                Papa.parse(evt.target.result, { header: true, complete: (res) => processar(res.data, res.meta.fields) });
            } else {
                const wb = XLSX.read(evt.target.result, { type: 'binary' });
                const d = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                processar(d, Object.keys(d[0] || {}));
            }
        };
        ext === 'csv' ? reader.readAsText(file) : reader.readAsBinaryString(file);
    };

    function processar(dados, colunas) {
        const limpar = (s) => s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().replace(/[^a-z0-9]/g, "");
        const acharCol = (termos) => colunas.find(c => termos.includes(limpar(c)));
        const cLat = acharCol(['latitude', 'lat']), cLon = acharCol(['longitude', 'long']);
        const cAddr = acharCol(['address', 'endereco', 'rua']), cBairro = acharCol(['bairro', 'neighborhood']);

        dadosOriginais = dados.map((row, index) => ({
            id: index,
            lat: parseFloat(String(row[cLat] || '').replace(',', '.')),
            lon: parseFloat(String(row[cLon] || '').replace(',', '.')),
            addr: row[cAddr] || "EndereÃ§o",
            bairro: row[cBairro] || "GoiÃ¢nia",
            concluido: false
        })).filter(p => !isNaN(p.lat) && !isNaN(p.lon));

        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('footer-ui').style.display = 'block';
        reotimizar();
    }

    function forcarRecalculo() {
        navigator.geolocation.getCurrentPosition(pos => {
            userPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            reotimizar();
        });
    }

    function reotimizar() {
        let pendentes = dadosOriginais.filter(p => !p.concluido);
        let finalizados = dadosOriginais.filter(p => p.concluido);
        let rotaNova = [];
        let atual = userPos || (pendentes.length > 0 ? {lat: pendentes[0].lat, lon: pendentes[0].lon} : null);

        while (pendentes.length > 0) {
            pendentes.sort((a, b) => Math.hypot(a.lat - atual.lat, a.lon - atual.lon) - Math.hypot(b.lat - atual.lat, b.lon - atual.lon));
            atual = pendentes.splice(0, 1)[0];
            rotaNova.push(atual);
        }
        desenhar(rotaNova, finalizados);
    }

    function desenhar(pendentes, finalizados) {
        layerGrupo.clearLayers();
        marcadoresRef = {};
        const listaDiv = document.getElementById('lista-entregas');
        listaDiv.innerHTML = '';
        const exibir = [...pendentes, ...finalizados];

        exibir.forEach((p, i) => {
            const marker = L.circleMarker([p.lat, p.lon], {
                radius: 10, color: p.concluido ? '#95a5a6' : '#00d1b2', fillColor: p.concluido ? '#bdc3c7' : '#00d1b2', fillOpacity: 0.8
            }).addTo(layerGrupo).bindPopup(p.addr);
            
            marcadoresRef[p.id] = marker;

            const card = document.createElement('div');
            card.className = `entrega-card ${p.concluido ? 'done' : ''}`;
            card.id = `card-${p.id}`;
            card.onclick = (e) => { if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A') focar(p.id); };
            card.innerHTML = `
                <span class="badge-bairro">${p.bairro}</span>
                <span class="endereco">${p.addr}</span>
                <div style="display: flex; gap: 8px;">
                    ${!p.concluido ? `<a class="btn-gps" href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">MAPS</a>` : ''}
                    <button class="btn-done" onclick="status(${p.id})">${p.concluido ? 'REABRIR' : 'OK'}</button>
                </div>
            `;
            listaDiv.appendChild(card);
        });
        document.getElementById('stats-text').innerText = `${pendentes.length} Pendentes | ${finalizados.length} OK`;
    }

    function focar(id) {
        const m = marcadoresRef[id];
        document.querySelectorAll('.entrega-card').forEach(c => c.classList.remove('selected'));
        document.getElementById(`card-${id}`).classList.add('selected');
        layerGrupo.eachLayer(l => { if(l.getElement()) l.getElement().classList.remove('marker-focus') });
        m.openPopup();
        map.flyTo(m.getLatLng(), 16);
        if(m.getElement()) m.getElement().classList.add('marker-focus');
    }

    function status(id) {
        const p = dadosOriginais.find(d => d.id === id);
        p.concluido = !p.concluido;
        reotimizar();
    }
</script>
</body>
</html>
