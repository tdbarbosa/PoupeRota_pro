<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gestor de Entregas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f2f2f2;
    }

    header {
      background: #2c3e50;
      color: white;
      padding: 10px;
      text-align: center;
    }

    #controls {
      padding: 10px;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #map {
      height: 50vh;
    }

    #addressList {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding: 10px;
      background: #fff;
    }

    .address-card {
      min-width: 220px;
      background: #ecf0f1;
      padding: 10px;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      border: 2px solid transparent;
    }

    .address-card.active {
      border-color: #e74c3c;
      background: #fdecea;
    }

    .address-card.delivered {
      background: #d5f5e3;
      border-color: #2ecc71;
      opacity: 0.7;
    }

    .address-card button {
      padding: 6px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-focus {
      background: #3498db;
      color: white;
    }

    .btn-delivered {
      background: #2ecc71;
      color: white;
    }

    .btn-remove {
      background: #e74c3c;
      color: white;
    }

    #log {
      padding: 10px;
      font-size: 12px;
      color: #555;
    }
  </style>
</head>
<body>

<header>
  <h2>Gestor de Entregas</h2>
</header>

<div id="controls">
  <input type="file" id="csvInput" accept=".csv" />
  <button onclick="loadSample()">Carregar exemplo</button>
</div>

<div id="map"></div>

<div id="addressList"></div>

<div id="log"></div>

<script>
  let map;
  let markers = [];
  let addresses = [];

  function log(msg) {
    document.getElementById("log").innerText = msg;
  }

  function initMap() {
    map = L.map('map').setView([-15.793889, -47.882778], 4); // Brasil

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);
  }

  function getAddressFromRow(row) {
    const possibleFields = [
      "endereço",
      "endereco",
      "address",
      "destination address",
      "destination_address",
      "logradouro",
      "rua",
      "local",
      "destino"
    ];

    for (const key in row) {
      const normalized = key.toLowerCase().trim();
      if (possibleFields.includes(normalized)) {
        return row[key].trim();
      }
    }
    return null;
  }

  function parseCSV(text) {
    const lines = text.split("\n").filter(l => l.trim() !== "");
    const headers = lines[0].split(",").map(h => h.trim());
    const rows = [];

    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(",");
      const row = {};
      headers.forEach((h, idx) => {
        row[h] = values[idx] ? values[idx].trim() : "";
      });
      rows.push(row);
    }
    return rows;
  }

  async function geocode(address) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
    const response = await fetch(url, { headers: { 'User-Agent': 'EntregaApp/1.0' } });
    const data = await response.json();
    if (data.length > 0) {
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }
    return null;
  }

  async function loadAddressesFromCSV(file) {
    const reader = new FileReader();
    reader.onload = async function (e) {
      const text = e.target.result;
      const rows = parseCSV(text);

      addresses = [];
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      for (const row of rows) {
        const address = getAddressFromRow(row);
        if (!address) {
          console.warn("Endereço não informado na linha:", row);
          continue;
        }

        const coords = await geocode(address);
        if (!coords) {
          console.warn("Não foi possível localizar:", address);
          continue;
        }

        const item = {
          id: Date.now() + Math.random(),
          address,
          lat: coords.lat,
          lon: coords.lon,
          delivered: false
        };

        addresses.push(item);
        addMarker(item);
      }

      renderAddressList();
      if (addresses.length > 0) {
        map.setView([addresses[0].lat, addresses[0].lon], 12);
      }
    };

    reader.readAsText(file);
  }

  function addMarker(item) {
    const marker = L.marker([item.lat, item.lon]).addTo(map);
    marker.bindPopup(item.address);
    marker._customId = item.id;
    markers.push(marker);
  }

  function highlightMarker(id) {
    markers.forEach(marker => {
      if (marker._customId === id) {
        marker.setIcon(L.icon({
          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',
          iconSize: [32, 32],
          iconAnchor: [16, 32]
        }));
        map.setView(marker.getLatLng(), 16);
        marker.openPopup();
      } else {
        marker.setIcon(L.icon({
          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',
          iconSize: [32, 32],
          iconAnchor: [16, 32]
        }));
      }
    });
  }

  function renderAddressList() {
    const container = document.getElementById("addressList");
    container.innerHTML = "";

    addresses.forEach(item => {
      const card = document.createElement("div");
      card.className = "address-card" + (item.delivered ? " delivered" : "");
      card.id = `card-${item.id}`;

      const addr = document.createElement("div");
      addr.innerText = item.address;

      const btnFocus = document.createElement("button");
      btnFocus.innerText = "Ver no mapa";
      btnFocus.className = "btn-focus";
      btnFocus.onclick = () => {
        setActiveCard(item.id);
        highlightMarker(item.id);
      };

      const btnDelivered = document.createElement("button");
      btnDelivered.innerText = item.delivered ? "Entregue ✔" : "Marcar entregue";
      btnDelivered.className = "btn-delivered";
      btnDelivered.onclick = () => toggleDelivered(item.id);

      const btnRemove = document.createElement("button");
      btnRemove.innerText = "Remover";
      btnRemove.className = "btn-remove";
      btnRemove.onclick = () => removeAddress(item.id);

      card.appendChild(addr);
      card.appendChild(btnFocus);
      card.appendChild(btnDelivered);
      card.appendChild(btnRemove);

      container.appendChild(card);
    });
  }

  function setActiveCard(id) {
    document.querySelectorAll('.address-card').forEach(card => card.classList.remove('active'));
    const card = document.getElementById(`card-${id}`);
    if (card) card.classList.add('active');
  }

  function toggleDelivered(id) {
    const item = addresses.find(a => a.id === id);
    if (!item) return;
    item.delivered = !item.delivered;
    renderAddressList();
  }

  function removeAddress(id) {
    addresses = addresses.filter(a => a.id !== id);

    markers.forEach(marker => {
      if (marker._customId === id) {
        map.removeLayer(marker);
      }
    });

    markers = markers.filter(m => m._customId !== id);
    renderAddressList();
  }

  document.getElementById("csvInput").addEventListener("change", function (e) {
    if (e.target.files.length > 0) {
      loadAddressesFromCSV(e.target.files[0]);
    }
  });

  function loadSample() {
    const sampleCSV = `Nome,Destination Address
Cliente 1,Rua XV de Novembro, Curitiba, PR
Cliente 2,Avenida Paulista, São Paulo, SP
Cliente 3,Esplanada dos Ministérios, Brasília, DF`;

    const blob = new Blob([sampleCSV], { type: 'text/csv' });
    const file = new File([blob], "exemplo.csv", { type: "text/csv" });
    loadAddressesFromCSV(file);
  }

  initMap();
</script>

</body>
</html>
