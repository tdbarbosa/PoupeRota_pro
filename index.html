<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoupeRota Pro - NavegaÃ§Ã£o Inteligente</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #00d1b2; --accent: #ff7f50; --dark-bg: #101820; 
            --card-bg: #1a232e; --text-main: #ffffff; --text-dim: #a0aec0; --danger: #ff4757;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; display: flex; height: 100vh; background: var(--dark-bg); color: var(--text-main); overflow: hidden; }
        
        #sidebar { 
            width: 380px; background: var(--card-bg); display: flex; flex-direction: column; 
            box-shadow: 10px 0 30px rgba(0,0,0,0.5); z-index: 1000; border-right: 1px solid #2d3748;
        }

        .header { 
            padding: 15px 20px; display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid #2d3748; background: rgba(0,0,0,0.2);
        }
        .logo-img { width: 42px; height: 42px; object-fit: contain; }
        .logo-text { font-size: 1.3rem; font-weight: 800; color: #fff; margin: 0; line-height: 1; }
        .pro-badge { color: var(--accent); font-style: italic; }
        .stats { font-size: 0.75rem; color: var(--text-dim); margin-top: 4px; }

        #lista-entregas { flex-grow: 1; overflow-y: auto; padding: 15px; scroll-behavior: smooth; }
        
        .entrega-card { 
            background: #242f3f; border-radius: 12px; padding: 16px; margin-bottom: 12px; 
            position: relative; border: 2px solid transparent; transition: 0.3s; cursor: pointer;
        }
        /* Estilo do Card Selecionado */
        .entrega-card.selected { border-color: var(--primary); background: #2d3a4d; transform: scale(1.02); }
        .entrega-card.done { opacity: 0.35; filter: grayscale(0.8); }
        
        .badge-bairro { 
            background: rgba(0, 209, 178, 0.1); color: var(--primary); 
            padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
        }
        .endereco { display: block; margin: 8px 0; font-size: 0.85rem; color: var(--text-main); line-height: 1.4; }
        
        .btn-gps { 
            background: #3498db; color: white; border: none; padding: 10px; 
            border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; text-decoration: none;
            display: inline-block; text-align: center; margin-bottom: 6px; font-size: 0.9rem;
        }
        .btn-done { 
            background: transparent; border: 1px solid #4a5568; color: var(--text-dim); 
            padding: 8px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600;
        }

        .footer-actions { padding: 15px; border-top: 1px solid #2d3748; background: #1a232e; }
        .btn-reotimizar { background: var(--primary); color: var(--dark-bg); border: none; padding: 12px; border-radius: 8px; font-weight: 700; width: 100%; cursor: pointer; }

        #map { flex-grow: 1; background: #0b0e14; }

        /* AnimaÃ§Ã£o do Marcador Destaque */
        @keyframes pulse {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.5); filter: brightness(1.5); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .marker-focus { animation: pulse 1s infinite; z-index: 9999 !important; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="header">
        <img src="logo.png" alt="Logo" class="logo-img">
        <div>
            <h1 class="logo-text">PoupeRota <span class="pro-badge">Pro</span></h1>
            <div id="stats-text" class="stats">Aguardando planilha...</div>
        </div>
    </div>

    <div id="upload-section" style="padding: 20px;">
        <div class="upload-box" onclick="document.getElementById('file-input').click()" style="border: 2px dashed #4a5568; padding: 30px; border-radius: 15px; text-align: center; cursor: pointer;">
            <span style="font-size: 2rem;">ðŸ“Š</span><br>
            <span style="font-size: 0.75rem; color: var(--text-dim)">Importar Romaneio</span>
            <input type="file" id="file-input" style="display:none" accept=".csv, .xlsx, .xls">
        </div>
    </div>
    
    <div id="lista-entregas"></div>

    <div class="footer-actions" id="footer-ui" style="display: none;">
        <button class="btn-reotimizar" onclick="reotimizar()">ðŸ”„ RECALCULAR ROTA</button>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false }).setView([-16.6808, -49.2563], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    let layerGrupo = L.layerGroup().addTo(map);
    let dadosOriginais = []; 
    let marcadoresRef = {}; // Guarda referÃªncia dos marcadores para dar foco

    navigator.geolocation.getCurrentPosition(pos => {
        window.minhaPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
    });

    document.getElementById('file-input').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        const ext = file.name.split('.').pop().toLowerCase();
        reader.onload = (evt) => {
            let d;
            if (ext === 'csv') {
                Papa.parse(evt.target.result, { header: true, complete: (res) => carregarDados(res.data, res.meta.fields) });
            } else {
                const wb = XLSX.read(evt.target.result, { type: 'binary' });
                d = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                carregarDados(d, Object.keys(d[0] || {}));
            }
        };
        ext === 'csv' ? reader.readAsText(file) : reader.readAsBinaryString(file);
    };

    function carregarDados(dados, colunas) {
        const limpar = (s) => s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().replace(/[^a-z0-9]/g, "");
        const acharCol = (termos) => colunas.find(c => termos.includes(limpar(c)));
        const cLat = acharCol(['latitude', 'lat']), cLon = acharCol(['longitude', 'long']);
        const cAddr = acharCol(['address', 'endereco', 'rua']), cBairro = acharCol(['bairro', 'neighborhood']);

        dadosOriginais = dados.map((row, index) => ({
            id: index,
            lat: parseFloat(String(row[cLat] || '').replace(',', '.')),
            lon: parseFloat(String(row[cLon] || '').replace(',', '.')),
            addr: row[cAddr] || "EndereÃ§o nÃ£o identificado",
            bairro: row[cBairro] || "GoiÃ¢nia",
            concluido: false
        })).filter(p => !isNaN(p.lat) && !isNaN(p.lon));

        if (dadosOriginais.length > 0) {
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('footer-ui').style.display = 'block';
            reotimizar();
        }
    }

    function reotimizar() {
        let pendentes = dadosOriginais.filter(p => !p.concluido);
        let finalizados = dadosOriginais.filter(p => p.concluido);
        let rotaNova = [];
        let atual = window.minhaPos || (pendentes.length > 0 ? {lat: pendentes[0].lat, lon: pendentes[0].lon} : null);

        while (pendentes.length > 0) {
            pendentes.sort((a, b) => Math.hypot(a.lat - atual.lat, a.lon - atual.lon) - Math.hypot(b.lat - atual.lat, b.lon - atual.lon));
            atual = pendentes.splice(0, 1)[0];
            rotaNova.push(atual);
        }
        desenhar(rotaNova, finalizados);
    }

    function desenhar(pendentes, finalizados) {
        layerGrupo.clearLayers();
        marcadoresRef = {};
        const listaDiv = document.getElementById('lista-entregas');
        listaDiv.innerHTML = '';
        const exibir = [...pendentes, ...finalizados];

        exibir.forEach((p, i) => {
            const marker = L.circleMarker([p.lat, p.lon], {
                radius: 9, color: p.concluido ? '#4a5568' : '#00d1b2', fillColor: p.concluido ? '#2d3748' : '#00d1b2', fillOpacity: 0.9
            }).addTo(layerGrupo).bindPopup(`<b>#${i+1}</b><br>${p.addr}`);
            
            marcadoresRef[p.id] = marker; // Salva referÃªncia pelo ID original

            const card = document.createElement('div');
            card.className = `entrega-card ${p.concluido ? 'done' : ''}`;
            card.id = `card-${p.id}`;
            card.onclick = (e) => {
                if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A') focarNoPonto(p.id);
            };
            card.innerHTML = `
                <span class="badge-bairro">${p.bairro}</span>
                <span class="endereco">${p.addr}</span>
                <div style="display: flex; gap: 8px;">
                    ${!p.concluido ? `<a class="btn-gps" href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">MAPS</a>` : ''}
                    <button class="btn-done" onclick="alternarStatus(${p.id})">${p.concluido ? 'VOLTAR' : 'CONCLUIR'}</button>
                </div>
            `;
            listaDiv.appendChild(card);
        });
        if (exibir.length > 0) map.fitBounds(L.featureGroup(layerGrupo.getLayers()).getBounds(), {padding: [50,50]});
    }

    function focarNoPonto(id) {
        const marker = marcadoresRef[id];
        const card = document.getElementById(`card-${id}`);
        
        // Remove destaques anteriores
        document.querySelectorAll('.entrega-card').forEach(c => c.classList.remove('selected'));
        layerGrupo.eachLayer(l => { if(l.getElement()) l.getElement().classList.remove('marker-focus') });

        // Aplica destaque novo
        card.classList.add('selected');
        marker.openPopup();
        map.flyTo(marker.getLatLng(), 16);
        
        // Adiciona classe de animaÃ§Ã£o ao marcador (via elemento DOM)
        if(marker.getElement()) marker.getElement().classList.add('marker-focus');
    }

    function alternarStatus(id) {
        const p = dadosOriginais.find(d => d.id === id);
        if (p) { p.concluido = !p.concluido; reotimizar(); }
    }
</script>
</body>
</html>
