<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>PoupeRota Pro</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root {
  --primary: #00d1b2;
  --accent: #ff7f50;
  --bg: #f4f7f6;
  --card: #ffffff;
  --text: #2d3748;
  --border: #e2e8f0;
}
[data-theme="dark"] {
  --bg: #101820;
  --card: #1a232e;
  --text: #ffffff;
  --border: #2d3748;
}
body {
  margin: 0;
  display: flex;
  height: 100vh;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
  font-family: Inter, sans-serif;
}
#sidebar {
  width: 380px;
  background: var(--card);
  display: flex;
  flex-direction: column;
  z-index: 1000;
  border-right: 1px solid var(--border);
}
.header {
  padding: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
}
#upload-section {
  padding: 20px;
}
#lista-entregas {
  flex-grow: 1;
  overflow-x: auto;
  display: flex;
  gap: 12px;
  padding: 15px;
}
.entrega-card {
  min-width: 260px;
  background: var(--bg);
  border-radius: 12px;
  padding: 15px;
  border: 2px solid transparent;
  cursor: pointer;
  transition: 0.2s;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.entrega-card.active {
  border-color: var(--primary);
  background: rgba(0, 209, 178, 0.1);
}
.entrega-card.done {
  opacity: 0.35;
  filter: grayscale(1);
}
.custom-pin {
  background-color: var(--primary);
  border: 2px solid white;
  border-radius: 50%;
  width: 14px;
  height: 14px;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
}
.pin-active {
  background-color: var(--accent) !important;
  width: 20px !important;
  height: 20px !important;
  box-shadow: 0 0 20px var(--accent);
  animation: pulse 0.6s infinite alternate;
  z-index: 9999 !important;
}
@keyframes pulse {
  from { transform: scale(1); }
  to { transform: scale(1.4); }
}
#map {
  flex-grow: 1;
  height: 100vh;
  background: #0b0e14;
}
#footer-ui {
  padding: 15px;
  display: none;
}
@media (max-width: 768px) {
  body { flex-direction: column; }
  #sidebar {
    width: 100%;
    height: 45vh;
    position: fixed;
    bottom: 0;
    border-radius: 20px 20px 0 0;
  }
  #map { height: 55vh; width: 100%; }
}
</style>
</head>

<body data-theme="dark">

<div id="sidebar">
  <div class="header">
    <div style="display:flex; align-items:center; gap:10px">
      <img src="logo.png" style="width:30px" onerror="this.src='https://cdn-icons-png.flaticon.com/512/854/854878.png'">
      <h1 style="font-size: 1rem; margin:0">PoupeRota <span style="color:var(--accent)">Pro</span></h1>
    </div>
    <button onclick="toggleTheme()" style="background:none; border:none; cursor:pointer; font-size:1.2rem">‚òÄÔ∏è</button>
  </div>

  <div id="upload-section">
    <input type="file" id="file-input" style="display:none" accept=".csv, .xlsx, .xls">
    <button onclick="document.getElementById('file-input').click()" style="width:100%; padding:15px; border:2px dashed var(--primary); color:var(--primary); background:none; border-radius:10px; font-weight:bold; cursor:pointer; font-size: 0.9rem;">
      üìÇ SELECIONAR PLANILHA
    </button>
    <button onclick="carregarExemplo()" style="margin-top:10px; width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; background:none; cursor:pointer;">
      üß™ Carregar exemplo
    </button>
  </div>

  <div id="lista-entregas"></div>

  <div id="footer-ui">
    <button onclick="reotimizar(true)" style="width:100%; background:var(--primary); border:none; padding:15px; border-radius:10px; font-weight:800; cursor:pointer; color:#101820">
      üîÑ RECALCULAR DA MINHA POSI√á√ÉO
    </button>
  </div>
</div>

<div id="map"></div>

<script>
const map = L.map('map', { zoomControl: false }).setView([-16.68, -49.25], 13);
let tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
let layerMarkers = L.layerGroup().addTo(map);
let dados = [];
let marcadores = {};
let minhaPos = null;

navigator.geolocation.getCurrentPosition(
  p => minhaPos = { lat: p.coords.latitude, lon: p.coords.longitude },
  e => console.log("GPS indispon√≠vel.")
);

function toggleTheme() {
  const isDark = document.body.getAttribute('data-theme') === 'dark';
  document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
  tiles.setUrl(isDark
    ? 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'
    : 'https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png'
  );
}

document.getElementById('file-input').onchange = function (e) {
  if (!e.target.files[0]) return;
  const file = e.target.files[0];
  const ext = file.name.split('.').pop().toLowerCase();

  if (ext === 'csv') {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: res => processarDados(res.data)
    });
  } else {
    const reader = new FileReader();
    reader.onload = function (evt) {
      try {
        const wb = XLSX.read(evt.target.result, { type: 'binary' });
        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        processarDados(json);
      } catch (err) {
        alert("Erro ao ler arquivo.");
      }
    };
    reader.readAsBinaryString(file);
  }
};

function normalizarCampo(row, nomes) {
  for (const nome of nomes) {
    if (row[nome] !== undefined && row[nome] !== null && row[nome] !== "") {
      return row[nome];
    }
  }
  return "";
}

function processarDados(json) {
  dados = json.map((r, i) => {
    const lat = parseFloat(normalizarCampo(r, ["Latitude", "lat", "LAT", "Lat"]));
    const lon = parseFloat(normalizarCampo(r, ["Longitude", "lon", "LONG", "Long"]));
    const addr = normalizarCampo(r, [
      "Endere√ßo", "Endereco", "ENDERECO",
      "Address", "ADDRESS",
      "Destination Address", "destination address", "DESTINATION ADDRESS"
    ]);
    const bairro = normalizarCampo(r, ["Bairro", "BAIRRO", "District", "DISTRICT"]);

    return {
      id: i,
      lat,
      lon,
      addr: addr || "Endere√ßo n√£o informado",
      bairro: bairro || "",
      done: false
    };
  }).filter(p => !isNaN(p.lat) && !isNaN(p.lon));

  if (dados.length === 0) {
    alert("Nenhuma coordenada v√°lida encontrada.");
    return;
  }

  document.getElementById('upload-section').style.display = 'none';
  document.getElementById('footer-ui').style.display = 'block';
  reotimizar(true);
}

function carregarExemplo() {
  const exemplo = [
    { Latitude: -16.686, Longitude: -49.264, "Destination Address": "Rua 1, Centro", Bairro: "Centro" },
    { Latitude: -16.695, Longitude: -49.259, "Destination Address": "Av. Goi√°s, Setor Sul", Bairro: "Setor Sul" },
    { Latitude: -16.675, Longitude: -49.248, "Destination Address": "Rua 10, Jardim Am√©rica", Bairro: "Jardim Am√©rica" }
  ];
  processarDados(exemplo);
}

function reotimizar(pelaMinhaPos) {
  let pendentes = dados.filter(d => !d.done);
  let concluidos = dados.filter(d => d.done);
  let rota = [];

  let atual = (pelaMinhaPos && minhaPos)
    ? minhaPos
    : (pendentes.length > 0 ? { lat: pendentes[0].lat, lon: pendentes[0].lon } : null);

  if (atual) {
    while (pendentes.length > 0) {
      pendentes.sort((a, b) =>
        Math.hypot(a.lat - atual.lat, a.lon - atual.lon) -
        Math.hypot(b.lat - atual.lat, b.lon - atual.lon)
      );
      atual = pendentes.shift();
      rota.push(atual);
    }
  }

  desenhar(rota, concluidos);
}

function desenhar(pendentes, concluidos) {
  layerMarkers.clearLayers();
  const lista = document.getElementById('lista-entregas');
  lista.innerHTML = '';
  marcadores = {};

  const total = [...pendentes, ...concluidos];
  total.forEach((p, i) => {
    const icon = L.divIcon({ className: 'custom-pin', iconSize: [14, 14] });
    const m = L.marker([p.lat, p.lon], { icon }).addTo(layerMarkers);
    marcadores[p.id] = m;

    const card = document.createElement('div');
    card.id = `card-${p.id}`;
    card.className = `entrega-card ${p.done ? 'done' : ''}`;
    card.onclick = () => focar(p.id);

    card.innerHTML = `
      <div style="display:flex; justify-content:space-between">
        <small style="color:var(--accent); font-weight:800; text-transform:uppercase">${p.bairro}</small>
        ${!p.done ? `<b style="color:var(--primary)">#${i + 1}</b>` : ''}
      </div>
      <div style="font-weight:600; margin:8px 0; font-size:0.9rem">${p.addr}</div>
      <div style="display:flex; gap:8px">
        <button onclick="event.stopPropagation(); window.open('https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}', '_blank')" style="flex:1; background:var(--primary); border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer">
          GPS
        </button>
        <button onclick="event.stopPropagation(); status(${p.id})" style="flex:1; background:none; border:1px solid var(--border); color:var(--text); border-radius:8px; cursor:pointer">
          ${p.done ? '‚Ü©Ô∏è' : '‚úÖ'}
        </button>
      </div>
    `;
    lista.appendChild(card);
  });

  if (total.length > 0) {
    map.fitBounds(layerMarkers.getBounds(), { padding: [50, 50] });
  }

  if (pendentes.length === 0 && concluidos.length > 0) {
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
  }
}

function focar(id) {
  const p = dados.find(x => x.id === id);
  if (!p) return;

  map.flyTo([p.lat, p.lon], 16, { animate: true, duration: 1 });

  document.querySelectorAll('.entrega-card').forEach(c => c.classList.remove('active'));
  const card = document.getElementById(`card-${id}`);
  if (card) card.classList.add('active');

  Object.values(marcadores).forEach(m => {
    const el = m.getElement();
    if (el) el.classList.remove('pin-active');
  });

  const elAtivo = marcadores[id]?.getElement();
  if (elAtivo) elAtivo.classList.add('pin-active');
}

function status(id) {
  const p = dados.find(x => x.id === id);
  if (!p) return;
  p.done = !p.done;
  reotimizar(false);
}
</script>
</body>
</html>
